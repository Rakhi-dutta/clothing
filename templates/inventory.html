{% extends "base.html" %}
{% block content %}

<h3 class="fw-bold mb-4">Inventory</h3>

<!-- ================= ADD NEW ITEM ================= -->
<div class="card shadow-sm p-4 mb-4">
    <h5 class="fw-semibold mb-3">Add New Clothing Item</h5>

    <form method="POST"
          action="{{ url_for('add_item') }}"
          enctype="multipart/form-data"
          class="row g-3">

        <div class="col-md-3">
            <input name="name" class="form-control" placeholder="Name" required>
        </div>

        <div class="col-md-3">
            <select name="category" class="form-select" required>
                <option value="">Select Category</option>
                {% for c in categories %}
                <option value="{{ c.name }}">{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-2">
            <input name="size" class="form-control" placeholder="Size (S/M/L/XL)" required>
        </div>

        <div class="col-md-2">
            <input name="quantity" type="number" class="form-control" placeholder="Qty" required>
        </div>

        <div class="col-md-2">
            <input name="price" type="number" step="0.01" class="form-control" placeholder="Price ₹" required>
        </div>

        <div class="col-md-4">
            <label class="form-label mb-1">Main Image</label>
            <input type="file" name="image" class="form-control" accept="image/*">
        </div>

        <div class="col-md-4">
            <label class="form-label mb-1">Gallery Images</label>
            <input type="file" name="gallery" class="form-control" accept="image/*" multiple>
            <small class="text-muted">You can select multiple images.</small>
        </div>

        <div class="col-12 text-end">
            <button class="btn btn-primary mt-2">Add Item</button>
        </div>
    </form>
</div>

<!-- ================= INVENTORY LIST + FILTERS ================= -->
<div class="card shadow-sm p-4 mb-4">

    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
        <h5 class="fw-semibold mb-0">
            Inventory List
            <span class="text-muted small">({{ total_items }} items)</span>
        </h5>

        <div class="d-flex gap-2">
            <!-- Export -->
            <a href="{{ url_for('export_inventory') }}"
               class="btn btn-success d-flex align-items-center gap-1">
                <i class="bi bi-file-earmark-excel"></i>
                <span>Export Excel</span>
            </a>

            <!-- Import -->
            <button class="btn btn-outline-success d-flex align-items-center gap-1"
                    data-bs-toggle="modal"
                    data-bs-target="#importModal">
                <i class="bi bi-cloud-upload"></i>
                <span>Import Excel</span>
            </button>
        </div>
    </div>

    <!-- FILTERS -->
    <form method="get" class="row gy-3 gx-3 mb-3">

        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                <input type="text"
                       name="q"
                       value="{{ q or '' }}"
                       class="form-control"
                       placeholder="Search by name, category or size...">
            </div>
        </div>

        <div class="col-md-3">
            <select name="sort" class="form-select">
                <option value="name_asc"  {% if sort=='name_asc' %}selected{% endif %}>Name A → Z</option>
                <option value="name_desc" {% if sort=='name_desc' %}selected{% endif %}>Name Z → A</option>
                <option value="qty_desc"  {% if sort=='qty_desc' %}selected{% endif %}>Qty High → Low</option>
                <option value="qty_asc"   {% if sort=='qty_asc' %}selected{% endif %}>Qty Low → High</option>
                <option value="price_asc" {% if sort=='price_asc' %}selected{% endif %}>Price Low → High</option>
                <option value="price_desc"{% if sort=='price_desc'%}selected{% endif %}>Price High → Low</option>
                <option value="created_desc"{% if sort=='created_desc'%}selected{% endif %}>Newest First</option>
                <option value="created_asc"{% if sort=='created_asc'%}selected{% endif %}>Oldest First</option>
            </select>
        </div>

        <div class="col-md-2">
            <select name="per_page" class="form-select">
                <option value="5"  {% if per_page==5  %}selected{% endif %}>5 rows</option>
                <option value="10" {% if per_page==10 %}selected{% endif %}>10 rows</option>
                <option value="20" {% if per_page==20 %}selected{% endif %}>20 rows</option>
                <option value="50" {% if per_page==50 %}selected{% endif %}>50 rows</option>
            </select>
        </div>

        <div class="col-md-3 d-flex gap-2">
            <button class="btn btn-primary flex-grow-1">Apply</button>
            <a href="{{ url_for('inventory') }}"
               class="btn btn-outline-secondary flex-grow-1">Reset</a>
        </div>
    </form>

    <!-- ================= INVENTORY TABLE ================= -->
    <div class="table-responsive">
        <table class="table table-hover table-bordered text-center align-middle mb-0">
            <thead class="table-primary">
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Size</th>
                    <th>Qty</th>
                    <th>Price (₹)</th>
                    <!-- <th>Codes</th> -->
                    <!-- <th>Stock</th>
                    <th>Gallery</th> -->
                    <th style="width: 150px;">Actions</th>
                </tr>
            </thead>

            <tbody>
            {% for item in items %}
                <tr>
                    <td>
                        {% if item.image %}
                            <img src="{{ url_for('uploaded_file', filename=item.image) }}"
                                 width="55" class="rounded shadow-sm">
                        {% else %}
                            <span class="text-muted">No Image</span>
                        {% endif %}
                    </td>

                    <td class="text-start fw-semibold">{{ item.name }}</td>
                    <td>{{ item.category }}</td>
                    <td>{{ item.size }}</td>

                    <td>
                        {% if item.quantity < 5 %}
                            <span class="badge bg-danger">Low ({{ item.quantity }})</span>
                        {% else %}
                            {{ item.quantity }}
                        {% endif %}
                    </td>

                    <td>{{ item.price }}</td>

                    <!-- Codes -->
                    <!-- <td>
                        <a href="/codes/regenerate/{{ item.id }}"
                           class="btn btn-sm btn-success w-100 d-flex align-items-center justify-content-center gap-1">
                            <i class="bi bi-arrow-repeat"></i>
                            <span>Generate</span>
                        </a>
                    </td> -->

                    <!-- Stock -->
                    <!-- <td>
                        <a href="{{ url_for('stock_adjust', item_id=item.id) }}"
                           class="btn btn-sm btn-outline-primary btn-icon"
                           title="Adjust stock">
                           <i class="bi bi-box-seam"></i>
                        </a>
                    </td> -->

                    <!-- Gallery -->
                    <!-- <td>
                        <a href="{{ url_for('item_gallery', item_id=item.id) }}"
                           class="btn btn-sm btn-outline-info btn-icon"
                           title="Open gallery">
                           <i class="bi bi-image"></i>
                        </a>
                    </td> -->

                    <!-- ACTION BUTTONS -->
                    <td>
                        <div class="action-grid">

                            <!-- Row 1 -->
                            <div class="action-row">
                                <!-- VIEW -->
                                <button class="action-btn btn-view"
                                        data-bs-toggle="modal"
                                        data-bs-target="#viewModal{{ item.id }}"
                                        title="View">
                                    <i class="bi bi-eye-fill"></i>
                                </button>

                                <!-- EDIT -->
                                <button class="action-btn btn-edit"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editModal{{ item.id }}"
                                        title="Edit">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>

                                <!-- DELETE -->
                                <button class="action-btn btn-delete"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteModal{{ item.id }}"
                                        title="Delete">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>

                            <!-- Row 2 -->
                            <div class="action-row">

                                <!-- GENERATE CODES -->
                                <a href="/codes/regenerate/{{ item.id }}"
                                class="action-btn btn-generate"
                                title="Generate Codes">
                                <i class="bi bi-arrow-repeat"></i>
                                </a>

                                <!-- STOCK -->
                                <a href="{{ url_for('stock_adjust', item_id=item.id) }}"
                                class="action-btn btn-stock"
                                title="Stock">
                                <i class="bi bi-box-seam"></i>
                                </a>

                                <!-- GALLERY -->
                                <a href="{{ url_for('item_gallery', item_id=item.id) }}"
                                class="action-btn btn-gallery"
                                title="Gallery">
                                <i class="bi bi-image-fill"></i>
                                </a>

                            </div>

                        </div>
                    </td>
                </tr>

                <!-- ========== VIEW DETAILS MODAL ========== -->
                <div class="modal fade" id="viewModal{{ item.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content shadow-lg">

                    <!-- HEADER -->
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title">
                        <i class="bi bi-info-circle me-2"></i> Item Details
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>

                    <!-- BODY -->
                    <div class="modal-body">

                        <!-- ========== TOP: MAIN IMAGE + DETAILS ========== -->
                        <div class="row g-4 align-items-start mb-4">

                        <!-- IMAGE -->
                        <div class="col-md-4 text-center">
                            {% if item.image %}
                            <img src="{{ url_for('uploaded_file', filename=item.image) }}"
                                class="img-fluid rounded shadow border"
                                style="max-height:240px; object-fit:cover;">
                            {% else %}
                            <div class="border rounded py-5 text-muted">No Image</div>
                            {% endif %}
                        </div>

                        <!-- DETAILS -->
                        <div class="col-md-8">
                            <h4 class="fw-bold">{{ item.name }}</h4>

                            <div class="row mt-3">
                            <div class="col-6"><strong>Category:</strong> {{ item.category }}</div>
                            <div class="col-6"><strong>Size:</strong> {{ item.size }}</div>
                            <div class="col-6 mt-2"><strong>Price:</strong> ₹{{ item.price }}</div>
                            <div class="col-6 mt-2"><strong>Quantity:</strong> {{ item.quantity }}</div>
                            <div class="col-12 mt-2 text-muted">
                                <strong>Created:</strong> {{ item.created_at }}
                            </div>
                            </div>
                        </div>
                        </div>

                        <hr>

                        <!-- ========== BARCODE + QR ROW ========== -->
                        <div class="row g-4 mb-4">

                        <!-- BARCODE -->
                        <div class="col-md-7">
                            <h6 class="fw-semibold">Barcode</h6>
                            {% if item.barcode %}
                            <div class="border rounded bg-white p-3 text-center shadow-sm">
                                <img src="{{ url_for('uploaded_file', filename=item.barcode) }}"
                                    class="img-fluid"
                                    style="max-height:120px; object-fit:contain;">
                            </div>
                            {% else %}
                            <p class="text-muted small">No barcode generated yet.</p>
                            {% endif %}
                        </div>

                        <!-- QR CODE -->
                        <div class="col-md-5">
                            <h6 class="fw-semibold">QR Code</h6>
                            {% if item.qrcode %}
                            <div class="border rounded bg-white p-3 text-center shadow-sm">
                                <img src="{{ url_for('uploaded_file', filename=item.qrcode) }}"
                                    style="max-width:160px; width:100%;">
                            </div>
                            {% else %}
                            <p class="text-muted small">No QR code generated yet.</p>
                            {% endif %}
                        </div>
                        </div>

                        <hr>

                        <!-- ========== GALLERY IMAGES SHOW ========== -->
                        <h6>Gallery Images</h6>

                        {% if gallery_map[item.id] %}
                            <div class="d-flex flex-wrap gap-2">
                                {% for g in gallery_map[item.id] %}
                                    <img src="{{ url_for('uploaded_file', filename=g.image) }}"
                                        class="rounded border"
                                        style="width: 100px; height: 100px; object-fit: cover;">
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted small">No gallery images uploaded.</p>
                        {% endif %}


                    </div>

                    <!-- FOOTER -->
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>

                    </div>
                </div>
                </div>


                <!-- ========== EDIT MODAL ========== -->
                <div class="modal fade" id="editModal{{ item.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">

                      <form method="POST"
                            action="{{ url_for('update_item', item_id=item.id) }}"
                            enctype="multipart/form-data">

                        <div class="modal-header bg-primary text-white">
                          <h5 class="modal-title">Edit Item</h5>
                          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <input name="name" value="{{ item.name }}" class="form-control" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select name="category" class="form-select" required>
                                    {% for c in categories %}
                                    <option value="{{ c.name }}"
                                            {% if c.name == item.category %}selected{% endif %}>
                                        {{ c.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Size</label>
                                <input name="size" value="{{ item.size }}" class="form-control" required>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Quantity</label>
                                <input name="quantity" type="number"
                                       value="{{ item.quantity }}"
                                       class="form-control" required>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Price (₹)</label>
                                <input name="price" type="number" step="0.01"
                                       value="{{ item.price }}"
                                       class="form-control" required>
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">Change Main Image</label>
                                <input type="file" name="image" class="form-control" accept="image/*">
                                <small class="text-muted">Leave empty to keep existing image.</small>
                            </div>
                        </div>

                        <div class="modal-footer">
                          <button class="btn btn-success">Save Changes</button>
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        </div>

                      </form>
                    </div>
                  </div>
                </div>

                <!-- ========== DELETE MODAL ========== -->
                <div class="modal fade" id="deleteModal{{ item.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                      <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Delete Item</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                      </div>

                      <div class="modal-body">
                        Are you sure you want to delete
                        <strong>{{ item.name }}</strong>?
                      </div>

                      <div class="modal-footer">
                        <a href="{{ url_for('delete_item', item_id=item.id) }}"
                           class="btn btn-danger">Delete</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      </div>

                    </div>
                  </div>
                </div>

            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- PAGINATION -->
    {% if pages %}
    <nav class="mt-3">
        <ul class="pagination justify-content-center gap-1">

            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link rounded-pill px-3"
                   href="{{ url_for('inventory', page=page-1, q=q, sort=sort, per_page=per_page) }}">
                    « Prev
                </a>
            </li>

            {% for p in pages %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link rounded-pill px-3"
                   href="{{ url_for('inventory', page=p, q=q, sort=sort, per_page=per_page) }}">
                    {{ p }}
                </a>
            </li>
            {% endfor %}

            <li class="page-item {% if page >= pages|length %}disabled{% endif %}">
                <a class="page-link rounded-pill px-3"
                   href="{{ url_for('inventory', page=page+1, q=q, sort=sort, per_page=per_page) }}">
                    Next »
                </a>
            </li>

        </ul>
    </nav>
    {% endif %}
</div>

<!-- ================= IMPORT MODAL ================= -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title fw-bold">Import Inventory (Excel)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form action="{{ url_for('import_inventory') }}"
            method="POST"
            enctype="multipart/form-data">
        <div class="modal-body">
            <label class="form-label fw-semibold">Upload Excel File (.xlsx)</label>
            <input type="file" name="excel_file" class="form-control" required>
            <small class="text-muted">
                Make sure the columns are: Name, Category, Size, Quantity, Price, Created At.
            </small>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-success">Import Now</button>
        </div>
      </form>

    </div>
  </div>
</div>

{% endblock %}
